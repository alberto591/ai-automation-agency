/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/langchain_core/_api/deprecation.py:26: UserWarning: Core Pydantic V1 functionality isn't compatible with Python 3.14 or greater.
  from pydantic.v1.fields import FieldInfo as FieldInfoV1
/Users/lycanbeats/Desktop/agenzia-ai/presentation/api/api.py:51: DeprecationWarning:
        on_event is deprecated, use lifespan event handlers instead.

        Read more about it in the
        [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).

  @app.on_event("startup")
INFO:     Started server process [49003]
INFO:     Waiting for application startup.
{"timestamp": "2026-01-01T14:26:30.286116+00:00", "level": "WARNING", "event": "SENTRY_DISABLED", "context": {"reason": "No DSN configured"}}
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     127.0.0.1:50482 - "GET /health HTTP/1.1" 200 OK
{"timestamp": "2026-01-01T14:26:39.347777+00:00", "level": "INFO", "event": "APPRAISAL_START", "context": {"city": "Florence", "zone": "50123", "property_type": "apartment", "surface_sqm": 120, "condition": "excellent", "bedrooms": null}}
{"timestamp": "2026-01-01T14:26:39.348635+00:00", "level": "INFO", "event": "PERPLEXITY_SEARCH", "context": {"query": "Find 3 active real estate listings for a apartment in Florence area 50123, around 120 sqm. Format: T", "has_context": false}}
{"timestamp": "2026-01-01T14:26:40.153998+00:00", "level": "ERROR", "event": "PERPLEXITY_FAILED", "context": {"error": "<html>\r\n<head><title>401 Authorization Required</title></head>\r\n<body>\r\n<center><h1>401 Authorization Required</h1></center>\r\n<hr><center>openresty/1.27.4</center>\r\n<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML=\"window.__CF$cv$params={r:'9b72b168ed89026a',t:'MTc2NzI3NzYwMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);\";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>\r\n</html>"}, "exception": "Traceback (most recent call last):\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/infrastructure/adapters/perplexity_adapter.py\", line 48, in search\n    response = self.client.chat.completions.create(model=self.model, messages=messages)\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/_utils/_utils.py\", line 286, in wrapper\n    return func(*args, **kwargs)\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/resources/chat/completions/completions.py\", line 1192, in create\n    return self._post(\n           ~~~~~~~~~~^\n        \"/chat/completions\",\n        ^^^^^^^^^^^^^^^^^^^^\n    ...<47 lines>...\n        stream_cls=Stream[ChatCompletionChunk],\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/_base_client.py\", line 1259, in post\n    return cast(ResponseT, self.request(cast_to, opts, stream=stream, stream_cls=stream_cls))\n                           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/_base_client.py\", line 1047, in request\n    raise self._make_status_error_from_response(err.response) from None\nopenai.AuthenticationError: <html>\r\n<head><title>401 Authorization Required</title></head>\r\n<body>\r\n<center><h1>401 Authorization Required</h1></center>\r\n<hr><center>openresty/1.27.4</center>\r\n<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML=\"window.__CF$cv$params={r:'9b72b168ed89026a',t:'MTc2NzI3NzYwMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);\";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>\r\n</html>\n"}
{"timestamp": "2026-01-01T14:26:40.164177+00:00", "level": "ERROR", "event": "APPRAISAL_RESEARCH_FAILED", "context": {"error": "Perplexity API search failed: <html>\r\n<head><title>401 Authorization Required</title></head>\r\n<body>\r\n<center><h1>401 Authorization Required</h1></center>\r\n<hr><center>openresty/1.27.4</center>\r\n<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML=\"window.__CF$cv$params={r:'9b72b168ed89026a',t:'MTc2NzI3NzYwMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);\";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>\r\n</html>"}, "exception": "Traceback (most recent call last):\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/infrastructure/adapters/perplexity_adapter.py\", line 48, in search\n    response = self.client.chat.completions.create(model=self.model, messages=messages)\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/_utils/_utils.py\", line 286, in wrapper\n    return func(*args, **kwargs)\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/resources/chat/completions/completions.py\", line 1192, in create\n    return self._post(\n           ~~~~~~~~~~^\n        \"/chat/completions\",\n        ^^^^^^^^^^^^^^^^^^^^\n    ...<47 lines>...\n        stream_cls=Stream[ChatCompletionChunk],\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/_base_client.py\", line 1259, in post\n    return cast(ResponseT, self.request(cast_to, opts, stream=stream, stream_cls=stream_cls))\n                           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/_base_client.py\", line 1047, in request\n    raise self._make_status_error_from_response(err.response) from None\nopenai.AuthenticationError: <html>\r\n<head><title>401 Authorization Required</title></head>\r\n<body>\r\n<center><h1>401 Authorization Required</h1></center>\r\n<hr><center>openresty/1.27.4</center>\r\n<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML=\"window.__CF$cv$params={r:'9b72b168ed89026a',t:'MTc2NzI3NzYwMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);\";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>\r\n</html>\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/application/services/appraisal.py\", line 36, in estimate_value\n    research_text = self.research.search(query)\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/infrastructure/adapters/perplexity_adapter.py\", line 57, in search\n    raise ExternalServiceError(\n        f\"Perplexity API search failed: {str(e)}\", cause=str(e)\n    ) from e\ndomain.errors.ExternalServiceError: Perplexity API search failed: <html>\r\n<head><title>401 Authorization Required</title></head>\r\n<body>\r\n<center><h1>401 Authorization Required</h1></center>\r\n<hr><center>openresty/1.27.4</center>\r\n<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML=\"window.__CF$cv$params={r:'9b72b168ed89026a',t:'MTc2NzI3NzYwMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);\";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>\r\n</html>\n"}
{"timestamp": "2026-01-01T14:26:40.167520+00:00", "level": "WARNING", "event": "APPRAISAL_NO_COMPS_FOUND", "context": {}}
DEBUG: parse_sqm called with 120mq
INFO:     127.0.0.1:50508 - "POST /api/appraisals/estimate HTTP/1.1" 200 OK
INFO:     127.0.0.1:51459 - "OPTIONS /api/leads HTTP/1.1" 200 OK
{"timestamp": "2026-01-01T14:30:05.765045+00:00", "level": "INFO", "event": "RECEIVED_LEAD_REQUEST", "context": {"name": "AI Appraisal Lead", "phone": "3331234567"}}
INFO:     127.0.0.1:51459 - "POST /api/leads HTTP/1.1" 400 Bad Request
INFO:     127.0.0.1:51459 - "OPTIONS /api/appraisals/estimate HTTP/1.1" 200 OK
{"timestamp": "2026-01-01T14:30:06.174168+00:00", "level": "INFO", "event": "APPRAISAL_START", "context": {"city": "Florence", "zone": "50123", "property_type": "apartment", "surface_sqm": 120, "condition": "excellent", "bedrooms": null}}
{"timestamp": "2026-01-01T14:30:06.176467+00:00", "level": "INFO", "event": "PERPLEXITY_SEARCH", "context": {"query": "Find 3 active real estate listings for a apartment in Florence area 50123, around 120 sqm. Format: T", "has_context": false}}
{"timestamp": "2026-01-01T14:30:06.780302+00:00", "level": "ERROR", "event": "PERPLEXITY_FAILED", "context": {"error": "<html>\r\n<head><title>401 Authorization Required</title></head>\r\n<body>\r\n<center><h1>401 Authorization Required</h1></center>\r\n<hr><center>openresty/1.27.4</center>\r\n<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML=\"window.__CF$cv$params={r:'9b72b6740c8904ad',t:'MTc2NzI3NzgwNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);\";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>\r\n</html>"}, "exception": "Traceback (most recent call last):\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/infrastructure/adapters/perplexity_adapter.py\", line 48, in search\n    response = self.client.chat.completions.create(model=self.model, messages=messages)\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/_utils/_utils.py\", line 286, in wrapper\n    return func(*args, **kwargs)\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/resources/chat/completions/completions.py\", line 1192, in create\n    return self._post(\n           ~~~~~~~~~~^\n        \"/chat/completions\",\n        ^^^^^^^^^^^^^^^^^^^^\n    ...<47 lines>...\n        stream_cls=Stream[ChatCompletionChunk],\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/_base_client.py\", line 1259, in post\n    return cast(ResponseT, self.request(cast_to, opts, stream=stream, stream_cls=stream_cls))\n                           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/_base_client.py\", line 1047, in request\n    raise self._make_status_error_from_response(err.response) from None\nopenai.AuthenticationError: <html>\r\n<head><title>401 Authorization Required</title></head>\r\n<body>\r\n<center><h1>401 Authorization Required</h1></center>\r\n<hr><center>openresty/1.27.4</center>\r\n<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML=\"window.__CF$cv$params={r:'9b72b6740c8904ad',t:'MTc2NzI3NzgwNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);\";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>\r\n</html>\n"}
{"timestamp": "2026-01-01T14:30:06.824123+00:00", "level": "ERROR", "event": "APPRAISAL_RESEARCH_FAILED", "context": {"error": "Perplexity API search failed: <html>\r\n<head><title>401 Authorization Required</title></head>\r\n<body>\r\n<center><h1>401 Authorization Required</h1></center>\r\n<hr><center>openresty/1.27.4</center>\r\n<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML=\"window.__CF$cv$params={r:'9b72b6740c8904ad',t:'MTc2NzI3NzgwNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);\";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>\r\n</html>"}, "exception": "Traceback (most recent call last):\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/infrastructure/adapters/perplexity_adapter.py\", line 48, in search\n    response = self.client.chat.completions.create(model=self.model, messages=messages)\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/_utils/_utils.py\", line 286, in wrapper\n    return func(*args, **kwargs)\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/resources/chat/completions/completions.py\", line 1192, in create\n    return self._post(\n           ~~~~~~~~~~^\n        \"/chat/completions\",\n        ^^^^^^^^^^^^^^^^^^^^\n    ...<47 lines>...\n        stream_cls=Stream[ChatCompletionChunk],\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/_base_client.py\", line 1259, in post\n    return cast(ResponseT, self.request(cast_to, opts, stream=stream, stream_cls=stream_cls))\n                           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/_base_client.py\", line 1047, in request\n    raise self._make_status_error_from_response(err.response) from None\nopenai.AuthenticationError: <html>\r\n<head><title>401 Authorization Required</title></head>\r\n<body>\r\n<center><h1>401 Authorization Required</h1></center>\r\n<hr><center>openresty/1.27.4</center>\r\n<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML=\"window.__CF$cv$params={r:'9b72b6740c8904ad',t:'MTc2NzI3NzgwNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);\";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>\r\n</html>\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/application/services/appraisal.py\", line 36, in estimate_value\n    research_text = self.research.search(query)\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/infrastructure/adapters/perplexity_adapter.py\", line 57, in search\n    raise ExternalServiceError(\n        f\"Perplexity API search failed: {str(e)}\", cause=str(e)\n    ) from e\ndomain.errors.ExternalServiceError: Perplexity API search failed: <html>\r\n<head><title>401 Authorization Required</title></head>\r\n<body>\r\n<center><h1>401 Authorization Required</h1></center>\r\n<hr><center>openresty/1.27.4</center>\r\n<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML=\"window.__CF$cv$params={r:'9b72b6740c8904ad',t:'MTc2NzI3NzgwNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);\";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>\r\n</html>\n"}
{"timestamp": "2026-01-01T14:30:06.829247+00:00", "level": "WARNING", "event": "APPRAISAL_NO_COMPS_FOUND", "context": {}}
DEBUG: parse_sqm called with 120
INFO:     127.0.0.1:51459 - "POST /api/appraisals/estimate HTTP/1.1" 200 OK
INFO:     127.0.0.1:51575 - "OPTIONS /api/appraisals/generate-pdf HTTP/1.1" 200 OK
{"timestamp": "2026-01-01T14:30:31.452330+00:00", "level": "INFO", "event": "APPRAISAL_PDF_GENERATED", "context": {"path": "temp/documents/appraisal_20260101_153030.pdf"}}
{"timestamp": "2026-01-01T14:30:31.452851+00:00", "level": "INFO", "event": "PDF_GENERATED", "context": {"path": "temp/documents/appraisal_20260101_153030.pdf", "address": "Via Roma 1, Firenze (CAP: 50123)"}}
INFO:     127.0.0.1:51575 - "POST /api/appraisals/generate-pdf HTTP/1.1" 200 OK
{"timestamp": "2026-01-01T14:37:07.257952+00:00", "level": "INFO", "event": "RECEIVED_LEAD_REQUEST", "context": {"name": "AI Appraisal Lead", "phone": "+393331234567"}}
{"timestamp": "2026-01-01T14:37:07.267782+00:00", "level": "INFO", "event": "PROCESSING_LEAD", "context": {"phone": "+393331234567", "name": "AI Appraisal Lead"}}
{"timestamp": "2026-01-01T14:37:09.258732+00:00", "level": "INFO", "event": "FIFI_APPRAISAL_START", "context": {"phone": "+393331234567"}}
{"timestamp": "2026-01-01T14:37:11.835510+00:00", "level": "INFO", "event": "EXTRACTING_FEATURES", "context": {"description_len": 110}}
{"timestamp": "2026-01-01T14:37:11.836135+00:00", "level": "INFO", "event": "FEATURE_EXTRACTION_FAST_PATH_HIT", "context": {}}
{"timestamp": "2026-01-01T14:37:11.928031+00:00", "level": "INFO", "event": "MODEL_LOADED", "context": {"path": "models/fifi_xgboost_v1.json", "version": "v1.0", "n_features": 38}}
{"timestamp": "2026-01-01T14:37:11.928446+00:00", "level": "INFO", "event": "AVM_PREDICTION_START", "context": {"sqm": 120, "zone": "via-roma-1", "model_version": "v1.0"}}
{"timestamp": "2026-01-01T14:37:11.963070+00:00", "level": "INFO", "event": "AVM_PREDICTION_COMPLETE", "context": {"predicted_value": 799216.4375, "model_version": "v1.0"}}
{"timestamp": "2026-01-01T14:37:12.291440+00:00", "level": "INFO", "event": "AUDIT_LOG_SUCCESS", "context": {"phone": "+393331234567"}}
{"timestamp": "2026-01-01T14:37:12.293385+00:00", "level": "INFO", "event": "HANDOFF_TRIGGERED", "context": {"phone": "+393331234567"}}
{"timestamp": "2026-01-01T14:37:12.300450+00:00", "level": "WARNING", "event": "SMTP_NOT_CONFIGURED", "context": {"reason": "Missing credentials"}}
{"timestamp": "2026-01-01T14:37:13.695892+00:00", "level": "INFO", "event": "MESSAGE_SENT", "context": {"to": "whatsapp:+393331234567", "sid": "SM8821ff98cf07fe8b61c831e151bbe1d1", "has_media": false}}
{"timestamp": "2026-01-01T14:37:13.696882+00:00", "level": "INFO", "event": "FINALIZING_METADATA", "context": {"metadata": {"preferences": {"rooms": [], "zones": [], "features": [], "property_types": []}, "sentiment": {"sentiment": "NEUTRAL", "urgency": "LOW", "notes": "Init"}, "last_intent": null, "source": "FIFI_APPRAISAL", "context_data": {}, "qualification_data": {}, "lead_score": {}}}}
{"timestamp": "2026-01-01T14:37:16.051506+00:00", "level": "INFO", "event": "GOOGLE_SHEETS_CONNECTED", "context": {"sheet_id": "1TYyvnFy6QxQJYiQvvkMdvpIQ5ApzwIxKvXe0hAb8GxI"}}
{"timestamp": "2026-01-01T14:37:17.896818+00:00", "level": "INFO", "event": "GOOGLE_SHEETS_ROW_UPDATED", "context": {"phone": "+393331234567", "row": 3}}
INFO:     127.0.0.1:53466 - "POST /api/leads HTTP/1.1" 200 OK
{"timestamp": "2026-01-01T14:37:17.925263+00:00", "level": "INFO", "event": "APPRAISAL_START", "context": {"city": "Florence", "zone": "50123", "property_type": "apartment", "surface_sqm": 120, "condition": "excellent", "bedrooms": null}}
{"timestamp": "2026-01-01T14:37:17.925534+00:00", "level": "INFO", "event": "PERPLEXITY_SEARCH", "context": {"query": "Find 3 active real estate listings for a apartment in Florence area 50123, around 120 sqm. Format: T", "has_context": false}}
{"timestamp": "2026-01-01T14:37:18.230300+00:00", "level": "ERROR", "event": "PERPLEXITY_FAILED", "context": {"error": "<html>\r\n<head><title>401 Authorization Required</title></head>\r\n<body>\r\n<center><h1>401 Authorization Required</h1></center>\r\n<hr><center>openresty/1.27.4</center>\r\n<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML=\"window.__CF$cv$params={r:'9b72c0fce977026a',t:'MTc2NzI3ODIzOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);\";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>\r\n</html>"}, "exception": "Traceback (most recent call last):\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/infrastructure/adapters/perplexity_adapter.py\", line 48, in search\n    response = self.client.chat.completions.create(model=self.model, messages=messages)\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/_utils/_utils.py\", line 286, in wrapper\n    return func(*args, **kwargs)\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/resources/chat/completions/completions.py\", line 1192, in create\n    return self._post(\n           ~~~~~~~~~~^\n        \"/chat/completions\",\n        ^^^^^^^^^^^^^^^^^^^^\n    ...<47 lines>...\n        stream_cls=Stream[ChatCompletionChunk],\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/_base_client.py\", line 1259, in post\n    return cast(ResponseT, self.request(cast_to, opts, stream=stream, stream_cls=stream_cls))\n                           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/_base_client.py\", line 1047, in request\n    raise self._make_status_error_from_response(err.response) from None\nopenai.AuthenticationError: <html>\r\n<head><title>401 Authorization Required</title></head>\r\n<body>\r\n<center><h1>401 Authorization Required</h1></center>\r\n<hr><center>openresty/1.27.4</center>\r\n<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML=\"window.__CF$cv$params={r:'9b72c0fce977026a',t:'MTc2NzI3ODIzOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);\";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>\r\n</html>\n"}
{"timestamp": "2026-01-01T14:37:18.232845+00:00", "level": "ERROR", "event": "APPRAISAL_RESEARCH_FAILED", "context": {"error": "Perplexity API search failed: <html>\r\n<head><title>401 Authorization Required</title></head>\r\n<body>\r\n<center><h1>401 Authorization Required</h1></center>\r\n<hr><center>openresty/1.27.4</center>\r\n<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML=\"window.__CF$cv$params={r:'9b72c0fce977026a',t:'MTc2NzI3ODIzOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);\";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>\r\n</html>"}, "exception": "Traceback (most recent call last):\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/infrastructure/adapters/perplexity_adapter.py\", line 48, in search\n    response = self.client.chat.completions.create(model=self.model, messages=messages)\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/_utils/_utils.py\", line 286, in wrapper\n    return func(*args, **kwargs)\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/resources/chat/completions/completions.py\", line 1192, in create\n    return self._post(\n           ~~~~~~~~~~^\n        \"/chat/completions\",\n        ^^^^^^^^^^^^^^^^^^^^\n    ...<47 lines>...\n        stream_cls=Stream[ChatCompletionChunk],\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/_base_client.py\", line 1259, in post\n    return cast(ResponseT, self.request(cast_to, opts, stream=stream, stream_cls=stream_cls))\n                           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/_base_client.py\", line 1047, in request\n    raise self._make_status_error_from_response(err.response) from None\nopenai.AuthenticationError: <html>\r\n<head><title>401 Authorization Required</title></head>\r\n<body>\r\n<center><h1>401 Authorization Required</h1></center>\r\n<hr><center>openresty/1.27.4</center>\r\n<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML=\"window.__CF$cv$params={r:'9b72c0fce977026a',t:'MTc2NzI3ODIzOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);\";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>\r\n</html>\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/application/services/appraisal.py\", line 36, in estimate_value\n    research_text = self.research.search(query)\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/infrastructure/adapters/perplexity_adapter.py\", line 57, in search\n    raise ExternalServiceError(\n        f\"Perplexity API search failed: {str(e)}\", cause=str(e)\n    ) from e\ndomain.errors.ExternalServiceError: Perplexity API search failed: <html>\r\n<head><title>401 Authorization Required</title></head>\r\n<body>\r\n<center><h1>401 Authorization Required</h1></center>\r\n<hr><center>openresty/1.27.4</center>\r\n<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML=\"window.__CF$cv$params={r:'9b72c0fce977026a',t:'MTc2NzI3ODIzOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);\";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>\r\n</html>\n"}
{"timestamp": "2026-01-01T14:37:18.234792+00:00", "level": "WARNING", "event": "APPRAISAL_NO_COMPS_FOUND", "context": {}}
DEBUG: parse_sqm called with 120
INFO:     127.0.0.1:53466 - "POST /api/appraisals/estimate HTTP/1.1" 200 OK
{"timestamp": "2026-01-01T14:37:41.663831+00:00", "level": "INFO", "event": "APPRAISAL_PDF_GENERATED", "context": {"path": "temp/documents/appraisal_20260101_153741.pdf"}}
{"timestamp": "2026-01-01T14:37:41.664918+00:00", "level": "INFO", "event": "PDF_GENERATED", "context": {"path": "temp/documents/appraisal_20260101_153741.pdf", "address": "Via Roma 1, Firenze (CAP: 50123)"}}
INFO:     127.0.0.1:53634 - "POST /api/appraisals/generate-pdf HTTP/1.1" 200 OK
INFO:     127.0.0.1:57406 - "OPTIONS /api/leads HTTP/1.1" 200 OK
{"timestamp": "2026-01-01T14:51:18.106243+00:00", "level": "INFO", "event": "RECEIVED_LEAD_REQUEST", "context": {"name": "AI Appraisal Lead", "phone": "+393337654321"}}
{"timestamp": "2026-01-01T14:51:18.116030+00:00", "level": "INFO", "event": "PROCESSING_LEAD", "context": {"phone": "+393337654321", "name": "AI Appraisal Lead"}}
{"timestamp": "2026-01-01T14:51:19.970428+00:00", "level": "INFO", "event": "FIFI_APPRAISAL_START", "context": {"phone": "+393337654321"}}
{"timestamp": "2026-01-01T14:51:19.973196+00:00", "level": "INFO", "event": "EXTRACTING_FEATURES", "context": {"description_len": 107}}
{"timestamp": "2026-01-01T14:51:19.973792+00:00", "level": "INFO", "event": "FEATURE_EXTRACTION_FAST_PATH_HIT", "context": {}}
{"timestamp": "2026-01-01T14:51:21.746793+00:00", "level": "INFO", "event": "MODEL_LOADED", "context": {"path": "models/fifi_xgboost_v1.json", "version": "v1.0", "n_features": 38}}
{"timestamp": "2026-01-01T14:51:21.747751+00:00", "level": "INFO", "event": "AVM_PREDICTION_START", "context": {"sqm": 85, "zone": "via-garibaldi-15", "model_version": "v1.0"}}
{"timestamp": "2026-01-01T14:51:22.211918+00:00", "level": "INFO", "event": "AVM_PREDICTION_COMPLETE", "context": {"predicted_value": 540054.6875, "model_version": "v1.0"}}
{"timestamp": "2026-01-01T14:51:22.962268+00:00", "level": "INFO", "event": "AUDIT_LOG_SUCCESS", "context": {"phone": "+393337654321"}}
{"timestamp": "2026-01-01T14:51:22.995227+00:00", "level": "INFO", "event": "HANDOFF_TRIGGERED", "context": {"phone": "+393337654321"}}
{"timestamp": "2026-01-01T14:51:23.041036+00:00", "level": "WARNING", "event": "SMTP_NOT_CONFIGURED", "context": {"reason": "Missing credentials"}}
{"timestamp": "2026-01-01T14:51:25.388898+00:00", "level": "INFO", "event": "MESSAGE_SENT", "context": {"to": "whatsapp:+393337654321", "sid": "SM9ae2128c6409ac487cbe7b283c2d5b1c", "has_media": false}}
{"timestamp": "2026-01-01T14:51:25.439412+00:00", "level": "INFO", "event": "FINALIZING_METADATA", "context": {"metadata": {"preferences": {"rooms": [], "zones": [], "features": [], "property_types": []}, "sentiment": {"sentiment": "NEUTRAL", "urgency": "LOW", "notes": "Init"}, "last_intent": null, "source": "FIFI_APPRAISAL", "context_data": {}, "qualification_data": {}, "lead_score": {}}}}
{"timestamp": "2026-01-01T14:51:27.840784+00:00", "level": "INFO", "event": "GOOGLE_SHEETS_ROW_APPENDED", "context": {"phone": "+393337654321"}}
INFO:     127.0.0.1:57408 - "POST /api/leads HTTP/1.1" 200 OK
INFO:     127.0.0.1:57408 - "OPTIONS /api/appraisals/estimate HTTP/1.1" 200 OK
{"timestamp": "2026-01-01T14:51:27.959597+00:00", "level": "INFO", "event": "APPRAISAL_START", "context": {"city": "Rome", "zone": "00100", "property_type": "apartment", "surface_sqm": 85, "condition": "good", "bedrooms": null}}
{"timestamp": "2026-01-01T14:51:27.963214+00:00", "level": "INFO", "event": "PERPLEXITY_SEARCH", "context": {"query": "Find 3 active real estate listings for a apartment in Rome area 00100, around 85 sqm. Format: Title ", "has_context": false}}
{"timestamp": "2026-01-01T14:51:28.796966+00:00", "level": "ERROR", "event": "PERPLEXITY_FAILED", "context": {"error": "<html>\r\n<head><title>401 Authorization Required</title></head>\r\n<body>\r\n<center><h1>401 Authorization Required</h1></center>\r\n<hr><center>openresty/1.27.4</center>\r\n<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML=\"window.__CF$cv$params={r:'9b72d5bf7a35cfdc',t:'MTc2NzI3OTA4OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);\";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>\r\n</html>"}, "exception": "Traceback (most recent call last):\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/infrastructure/adapters/perplexity_adapter.py\", line 48, in search\n    response = self.client.chat.completions.create(model=self.model, messages=messages)\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/_utils/_utils.py\", line 286, in wrapper\n    return func(*args, **kwargs)\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/resources/chat/completions/completions.py\", line 1192, in create\n    return self._post(\n           ~~~~~~~~~~^\n        \"/chat/completions\",\n        ^^^^^^^^^^^^^^^^^^^^\n    ...<47 lines>...\n        stream_cls=Stream[ChatCompletionChunk],\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/_base_client.py\", line 1259, in post\n    return cast(ResponseT, self.request(cast_to, opts, stream=stream, stream_cls=stream_cls))\n                           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/_base_client.py\", line 1047, in request\n    raise self._make_status_error_from_response(err.response) from None\nopenai.AuthenticationError: <html>\r\n<head><title>401 Authorization Required</title></head>\r\n<body>\r\n<center><h1>401 Authorization Required</h1></center>\r\n<hr><center>openresty/1.27.4</center>\r\n<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML=\"window.__CF$cv$params={r:'9b72d5bf7a35cfdc',t:'MTc2NzI3OTA4OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);\";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>\r\n</html>\n"}
{"timestamp": "2026-01-01T14:51:29.236258+00:00", "level": "ERROR", "event": "APPRAISAL_RESEARCH_FAILED", "context": {"error": "Perplexity API search failed: <html>\r\n<head><title>401 Authorization Required</title></head>\r\n<body>\r\n<center><h1>401 Authorization Required</h1></center>\r\n<hr><center>openresty/1.27.4</center>\r\n<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML=\"window.__CF$cv$params={r:'9b72d5bf7a35cfdc',t:'MTc2NzI3OTA4OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);\";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>\r\n</html>"}, "exception": "Traceback (most recent call last):\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/infrastructure/adapters/perplexity_adapter.py\", line 48, in search\n    response = self.client.chat.completions.create(model=self.model, messages=messages)\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/_utils/_utils.py\", line 286, in wrapper\n    return func(*args, **kwargs)\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/resources/chat/completions/completions.py\", line 1192, in create\n    return self._post(\n           ~~~~~~~~~~^\n        \"/chat/completions\",\n        ^^^^^^^^^^^^^^^^^^^^\n    ...<47 lines>...\n        stream_cls=Stream[ChatCompletionChunk],\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/_base_client.py\", line 1259, in post\n    return cast(ResponseT, self.request(cast_to, opts, stream=stream, stream_cls=stream_cls))\n                           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/venv/lib/python3.14/site-packages/openai/_base_client.py\", line 1047, in request\n    raise self._make_status_error_from_response(err.response) from None\nopenai.AuthenticationError: <html>\r\n<head><title>401 Authorization Required</title></head>\r\n<body>\r\n<center><h1>401 Authorization Required</h1></center>\r\n<hr><center>openresty/1.27.4</center>\r\n<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML=\"window.__CF$cv$params={r:'9b72d5bf7a35cfdc',t:'MTc2NzI3OTA4OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);\";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>\r\n</html>\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/application/services/appraisal.py\", line 36, in estimate_value\n    research_text = self.research.search(query)\n  File \"/Users/lycanbeats/Desktop/agenzia-ai/infrastructure/adapters/perplexity_adapter.py\", line 57, in search\n    raise ExternalServiceError(\n        f\"Perplexity API search failed: {str(e)}\", cause=str(e)\n    ) from e\ndomain.errors.ExternalServiceError: Perplexity API search failed: <html>\r\n<head><title>401 Authorization Required</title></head>\r\n<body>\r\n<center><h1>401 Authorization Required</h1></center>\r\n<hr><center>openresty/1.27.4</center>\r\n<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML=\"window.__CF$cv$params={r:'9b72d5bf7a35cfdc',t:'MTc2NzI3OTA4OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);\";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>\r\n</html>\n"}
{"timestamp": "2026-01-01T14:51:29.291652+00:00", "level": "WARNING", "event": "APPRAISAL_NO_COMPS_FOUND", "context": {}}
DEBUG: parse_sqm called with 85
INFO:     127.0.0.1:57408 - "POST /api/appraisals/estimate HTTP/1.1" 200 OK
